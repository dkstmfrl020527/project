<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì¹´ì¹´ì˜¤ ë§›ì§‘ ì¶”ì²œ</title>
    <script type="text/javascript" th:src="'//dapi.kakao.com/v2/maps/sdk.js?appkey=' + ${kakaoJsKey}"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 300px; padding: 20px; background: #f5f5f5; overflow-y: auto; }
        .map-container { flex: 1; }
        #map { width: 100%; height: 100%; }
        .restaurant-item {
            padding: 10px; margin: 5px 0; background: white;
            border-radius: 5px; cursor: pointer; border: 1px solid #ddd;
        }
        .restaurant-item:hover { background: #e9ecef; }
    </style>
</head>
<body>
<div class="container">
    <div class="sidebar">
        <h2>ğŸ½ï¸ ì£¼ë³€ ë§›ì§‘</h2>
        <p>ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ì£¼ë³€ ë§›ì§‘ì´ í‘œì‹œë©ë‹ˆë‹¤!</p>
        <div id="restaurantList"></div>
    </div>
    <div class="map-container">
        <div id="map"></div>
    </div>
</div>

<script>
    let map;
    let markers = [];

    // ì§€ë„ ì´ˆê¸°í™”
    const container = document.getElementById('map');
    const options = {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 3
    };
    map = new kakao.maps.Map(container, options);

    // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        const latlng = mouseEvent.latLng;
        const lat = latlng.getLat();
        const lon = latlng.getLng();

        console.log('í´ë¦­ ìœ„ì¹˜:', lat, lon);
        searchNearbyRestaurants(lat, lon);
    });

    // ì£¼ë³€ ì‹ë‹¹ ê²€ìƒ‰
    async function searchNearbyRestaurants(lat, lon) {
        try {
            const response = await fetch(`/api/recommend?lat=${lat}&lon=${lon}&radius=1000`);
            const restaurants = await response.json();

            console.log('ë°›ì€ ì‹ë‹¹ë“¤:', restaurants);
            displayRestaurants(restaurants);
            displayMarkers(restaurants);

        } catch (error) {
            console.error('ì˜¤ë¥˜:', error);
            document.getElementById('restaurantList').innerHTML =
                '<p style="color: red;">ì‹ë‹¹ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    }

    // ì‹ë‹¹ ëª©ë¡ í‘œì‹œ
    function displayRestaurants(restaurants) {
        const container = document.getElementById('restaurantList');

        if (!restaurants || restaurants.length === 0) {
            container.innerHTML = '<p>ì£¼ë³€ì— ì‹ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        container.innerHTML = restaurants.map(restaurant => `
            <div class="restaurant-item" onclick="moveToRestaurant(${restaurant.lat}, ${restaurant.lon})">
                <h4 style="margin: 0 0 5px 0;">${restaurant.name}</h4>
                <p style="margin: 0; font-size: 12px; color: #666;">${restaurant.category}</p>
                <p style="margin: 5px 0 0 0; font-size: 12px;">${restaurant.distance}m</p>
            </div>
        `).join('');
    }

    // ì‹ë‹¹ìœ¼ë¡œ ì§€ë„ ì´ë™
    function moveToRestaurant(lat, lon) {
        const moveLatLon = new kakao.maps.LatLng(lat, lon);
        map.setCenter(moveLatLon);
        map.setLevel(2); // ì¤Œ ì¸
    }

    // ì§€ë„ì— ë§ˆì»¤ í‘œì‹œ
    function displayMarkers(restaurants) {
        // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        markers.forEach(marker => marker.setMap(null));
        markers = [];

        restaurants.forEach(restaurant => {
            const position = new kakao.maps.LatLng(restaurant.lat, restaurant.lon);
            const marker = new kakao.maps.Marker({
                position: position,
                map: map
            });

            const infowindow = new kakao.maps.InfoWindow({
                content: `<div style="padding:10px;">${restaurant.name}</div>`
            });

            kakao.maps.event.addListener(marker, 'click', function() {
                infowindow.open(map, marker);
            });

            markers.push(marker);
        });
    }

    console.log('ë§›ì§‘ ì¶”ì²œ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ! ì§€ë„ë¥¼ í´ë¦­í•´ë³´ì„¸ìš”!');
</script>
</body>
</html>